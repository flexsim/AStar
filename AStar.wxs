<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--Note to self: if you're having issues with the msi replacing C:\Program Files\ with
  C:\Program Files (x86)\ make sure you have the compiler option -arch x64 -->

  <?include "$(var.ProjectDir)WixVariables.wxi" ?>

  <Product Id="$(var.ProductGUID)" Name="$(var.FullProductName)" Language="1033" Version="$(var.Version)" 
           Manufacturer="FlexSim Software Products Inc." UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" 
             Description="$(var.FullProductName)"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
		<MediaTemplate EmbedCab="yes"/>

    <Condition Message="The correct version of FlexSim is not found on this computer. Please install $(var.FlexSimVersion) $(var.Platform) before installing this module.">
      NOT (FLEXSIMINSTALLDIR = "") AND NOT Installed
    </Condition>

		<Feature Id="MainModule" Title="AStar Module" Level="1" ConfigurableDirectory="INSTALLDIR">
      <ComponentRef Id="DLLBinaries_x64"/>
      <ComponentRef Id="DLLBinaries_x86"/>
      <ComponentRef Id="ModuleTree"/>
      <ComponentGroupRef Id="group_bitmaps"/>
      <ComponentGroupRef Id="group_cursors"/>
      <ComponentGroupRef Id="group_shapes"/>
			<ComponentGroupRef Id="group_help" />
		</Feature>

    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion
        Minimum="$(var.MinUpradeVersion)" Maximum="$(var.Version)"
        Property="PREVIOUSVERSIONSINSTALLED"
        IncludeMinimum="yes" IncludeMaximum="yes" />
    </Upgrade>

    <UIRef Id="WixUI_InstallDir"/>
    <UIRef Id="WixUI_ErrorProgressText" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)FlexSimSoftwareLicenseAgreement.rtf"/>
    <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)SideImage.bmp"/>
    <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)TopImage.bmp"/>

    <Property Id="FLEXSIMINSTALLDIR" Secure="yes">
      <RegistrySearch Id="Locate_EXISTINGINSTALLDIR" 
                      Root="HKLM" 
                      Key="SOFTWARE\FlexSim\$(var.FlexSimVersion)" 
                      Name="InstallDir" Type="directory" />
    </Property>

    <CustomAction Id="SetInstallDir" Execute="firstSequence" Property="INSTALLDIR" Value="[FLEXSIMINSTALLDIR]\modules\AStar" />
    
    <CustomAction Id="LaunchApplication"
                  Directory="INSTALLDIR"
                  ExeCommand="[FLEXSIMINSTALLDIR]\program\flexsim.exe"
                  Execute="deferred"
                  Return="asyncNoWait" />

    <InstallUISequence>
      <Custom Action="SetInstallDir" After="FileCost">FLEXSIMINSTALLDIR</Custom>
    </InstallUISequence>

    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" Before="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>
    
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="INSTALLDIR" Name="AStar" FileSource=".\">
<!--Program GUIDs>
<FlexSim="B8FF3568-4258-4C2F-AD1E-1FB4499D7BDD">
</Program GUIDs-->
        <Component Id="DLLBinaries_x64" Guid="B8FF3568-4258-4C2F-AD1E-1FB4499D7BDD">
          <File Name="AStar.dll" />
        </Component>
<!--Program GUIDs>
<FlexSim="8C85D7DC-C100-4B3C-8689-BC093CA8D93F">
</Program GUIDs-->
        <Component Id="DLLBinaries_x86" Guid="8C85D7DC-C100-4B3C-8689-BC093CA8D93F">
          <File Name="AStar_x86.dll" />
        </Component>
<!--Program GUIDs>
<FlexSim="03C7E4DD-62F2-465C-AC18-D035161881F1">
</Program GUIDs-->
        <Component Id="ModuleTree" Guid="03C7E4DD-62F2-465C-AC18-D035161881F1">
          <File Name="AStar.t" />
        </Component>
      </Directory>
    </Directory>
  </Fragment>
</Wix>
